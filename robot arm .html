<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>ðŸš€ ESP32 Robot Arm Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="icon/7.ico" type="image/x-icon">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    /* Main App Styles */
    :root {
      --bg-start: #0a0a1a; --bg-end: #000; --text-main: #e0f2fe; --text-accent: #38bdf8;
      --text-secondary: #9ca3af; --glass-bg: rgba(20, 20, 40, 0.6); --glass-border: rgba(56, 189, 248, 0.2);
      --glow-color: rgba(56, 189, 248, 0.7); --btn-active-bg: #0c4a6e;
    }
    html.light {
      --bg-start: #f1f5f9; --bg-end: #e2e8f0; --text-main: #1e293b; --text-accent: #0284c7;
      --text-secondary: #475569; --glass-bg: rgba(255,255,255,0.4); --glass-border: rgba(0,0,0,0.1);
      --glow-color: rgba(2, 132, 199, 0.7); --btn-active-bg: #e0f2fe;
    }
    .app-body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, var(--bg-start), var(--bg-end));
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      transition: background 0.3s ease, border 0.3s ease;
    }
    .nav-btn.active { color: var(--text-accent); background: var(--glass-bg); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-glow {
        border: 1px solid transparent;
        transition: box-shadow 0.3s ease, transform 0.1s ease, background-color 0.3s, border-color 0.3s;
    }
    .btn-glow:hover {
        box-shadow: 0 0 15px var(--glow-color);
        border-color: var(--glow-color);
    }
    .btn-glow:active { transform: scale(0.95); }
    .joystick-container {
      position: relative;
      width: clamp(200px, 60vw, 300px);
      height: clamp(200px, 60vw, 300px);
      border-radius: 50%;
      background-image: radial-gradient(circle at center, rgba(56, 189, 248, 0.1) 0%, rgba(56, 189, 248, 0) 70%);
      border: 2px solid var(--glass-border);
      touch-action: none; /* Prevents scrolling on touch devices */
    }
    .joystick-handle {
      position: absolute;
      top: 50%; left: 50%;
      width: clamp(50px, 15vw, 75px);
      height: clamp(50px, 15vw, 75px);
      background: var(--text-accent);
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 0 20px var(--glow-color);
      transform: translate(-50%, -50%);
      cursor: grab;
      transition: transform 0.1s linear;
    }
    .joystick-handle.grabbing {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.1);
      transition: transform 0.1s ease;
    }
    #logBox::-webkit-scrollbar { width: 8px; }
    #logBox::-webkit-scrollbar-track { background: transparent; }
    #logBox::-webkit-scrollbar-thumb { background: var(--text-accent); border-radius: 4px; }
    #logBox::-webkit-scrollbar-thumb:hover { background: #0ea5e9; }

    /* Loader Styles */
    .loader-body{
      background: linear-gradient(to bottom right, #0a0a1a, #0c2a4d, #1a5a96);
    }
    .gear{animation:spin 3s linear infinite;}@keyframes spin{to{transform:rotate(360deg);}}
    .progress-bar{animation:progress 4s ease-in-out forwards;}@keyframes progress{0%{width:0}100%{width:100%}}
  </style>
</head>
<!-- Body starts with loader styles -->
<body class="flex items-center justify-center min-h-screen loader-body relative overflow-hidden">

  <!-- Loader Screen HTML -->
  <div id="loader-bg" class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(100,180,255,0.25),transparent_70%)] blur-2xl transition-opacity duration-500"></div>
  <div id="loader" class="z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl p-10 text-center shadow-2xl max-w-md w-11/12 transition-opacity duration-500">
    <div class="mx-auto mb-6 w-24 h-24 flex items-center justify-center rounded-full bg-gradient-to-br from-sky-400 to-blue-700 animate-pulse">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-white gear" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 3v2.25M4.5 6.75l1.5 1.5M3 12h2.25M4.5 17.25l1.5-1.5M9.75 21v-2.25M14.25 21v-2.25M19.5 17.25l-1.5-1.5M21 12h-2.25M19.5 6.75l-1.5 1.5M14.25 3v2.25M12 9a3 3 0 100 6 3 3 0 000-6z"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">Robot Arm Controller</h1>
    <p class="text-blue-200 mb-6 text-sm uppercase">Calibrating joints...</p>
    <div class="w-full bg-white/20 rounded-full h-2 overflow-hidden mb-4"><div class="progress-bar bg-gradient-to-r from-sky-400 to-blue-600 h-2 rounded-full"></div></div>
    <p class="text-blue-300 text-sm" id="progressText">Loading motors...</p>
  </div>

  <!-- Main App Container (Initially Hidden) -->
  <div id="app-container" class="hidden h-full w-full">

    <!-- Desktop Sidebar Navigation -->
    <nav class="hidden md:flex flex-col items-center space-y-4 fixed top-0 left-0 h-screen w-24 glass justify-center p-2 shadow-lg">
        <button class="nav-btn flex flex-col items-center justify-center p-3 rounded-lg w-full text-xs active" data-tab="dashboard" title="Dashboard">
            <i class="fas fa-tachometer-alt text-2xl mb-1"></i><span>Dashboard</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-3 rounded-lg w-full text-xs" data-tab="manual" title="Manual Control">
            <i class="fas fa-sliders-h text-2xl mb-1"></i><span>Manual</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-3 rounded-lg w-full text-xs" data-tab="sequencer" title="Sequencer">
            <i class="fas fa-tasks text-2xl mb-1"></i><span>Sequencer</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-3 rounded-lg w-full text-xs" data-tab="settings" title="Settings">
            <i class="fas fa-cog text-2xl mb-1"></i><span>Settings</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center p-3 rounded-lg w-full text-xs" data-tab="logs" title="Logs">
            <i class="fas fa-file-alt text-2xl mb-1"></i><span>Logs</span>
        </button>
    </nav>
    
    <div class="md:ml-24 flex flex-col items-center p-4 pb-24 md:pb-4 min-h-screen w-full">
        <!-- Header -->
        <header class="w-full max-w-6xl mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl md:text-5xl font-bold text-cyan-400">Robot Arm Command Center</h1>
                <button id="themeToggle" class="p-2 rounded-full glass focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    <i id="themeIcon" class="fa-solid fa-moon w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="w-full max-w-6xl">
            <!-- All tab-content sections go here -->
            <section id="dashboard" class="tab-content active">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="glass rounded-xl p-6 text-center md:col-span-2 lg:col-span-1">
                  <h2 class="text-xl font-bold text-cyan-300 mb-2">System Status</h2>
                  <p id="status" class="py-2 px-4 inline-block rounded-full border border-red-500 text-red-400 transition-all">DISCONNECTED</p>
                  <p id="sensor-data" class="mt-2 text-sm text-gray-400">Sensor Data: None</p>
                  <div class="mt-4 flex gap-2">
                    <button id="connectBtn" class="flex-1 px-4 py-3 bg-sky-600 rounded-lg font-semibold btn-glow">Connect</button>
                  </div>
                </div>
                <div class="glass rounded-xl p-6 lg:col-span-2">
                  <h2 class="text-xl font-bold text-cyan-300 mb-4 text-center">Quick Actions</h2>
                  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                    <button onclick="app.sendCommand('SEQ:HOME')" class="px-4 py-3 bg-blue-600 rounded-lg btn-glow">Home</button>
                    <button onclick="app.sendCommand('SEQ:PICK')" class="px-4 py-3 bg-purple-600 rounded-lg btn-glow">Pick</button>
                    <button onclick="app.sendCommand('SEQ:PLACE')" class="px-4 py-3 bg-yellow-600/80 rounded-lg btn-glow">Place</button>
                    <button onclick="app.sendCommand('SEQ:WAVE')" class="px-4 py-3 bg-green-600 rounded-lg btn-glow">Wave</button>
                    <button onclick="app.sendCommand('ESTOP')" class="px-4 py-3 bg-red-600 rounded-lg btn-glow col-span-2 sm:col-span-3 md:col-span-1">E-Stop</button>
                  </div>
                </div>
                <div class="glass rounded-xl p-6 md:col-span-2 lg:col-span-3">
                  <h2 class="text-xl font-bold text-cyan-300 mb-4 text-center">Joint Angles</h2>
                  <div id="joint-angles" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 text-center"></div>
                </div>
              </div>
            </section>

            <section id="manual" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col items-center justify-center glass rounded-xl p-6 order-2 lg:order-1">
                      <h3 class="font-semibold mb-2 text-center">Live Base/Shoulder Control</h3>
                      <p class="text-xs text-gray-400 mb-4">Drag handle to move. Let go to reset.</p>
                      <div id="joystick-container" class="joystick-container">
                        <div id="joystick-handle" class="joystick-handle"></div>
                      </div>
                    </div>
                    <div id="sliders" class="space-y-4 glass rounded-xl p-6 order-1 lg:order-2"></div>
                </div>
            </section>

            <section id="sequencer" class="tab-content">
                <div class="glass rounded-xl p-6">
                    <h2 class="text-xl font-bold text-cyan-300 mb-4">Motion Sequencer</h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                      <button onclick="app.sequencer.addStep()" class="px-4 py-2 bg-cyan-600 rounded-lg btn-glow">Add Pose</button>
                      <button id="playSeqBtn" onclick="app.sequencer.play()" class="px-4 py-2 bg-green-600 rounded-lg btn-glow">Play</button>
                      <button onclick="app.sequencer.clear()" class="px-4 py-2 bg-red-600 rounded-lg btn-glow">Clear</button>
                      <button onclick="app.sequencer.exportJSON()" class="px-4 py-2 bg-purple-600 rounded-lg btn-glow">Export</button>
                      <label class="px-4 py-2 bg-yellow-600/80 rounded-lg btn-glow cursor-pointer">Import
                        <input type="file" id="import-file" class="hidden" accept=".json">
                      </label>
                    </div>
                    <div id="sequence-progress" class="w-full bg-gray-700 rounded-full h-2.5 mb-4 hidden">
                      <div id="sequence-progress-bar" class="bg-cyan-400 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="sequenceList" class="space-y-2 text-gray-300 max-h-96 overflow-y-auto"></div>
                </div>
            </section>

            <section id="settings" class="tab-content">
              <div class="glass rounded-xl p-6 max-w-md mx-auto">
                <h2 class="text-xl font-bold text-cyan-300 mb-4">Settings</h2>
                <div class="space-y-4">
                  <div>
                    <label for="nServos" class="block mb-2 text-sm font-medium">Number of Servos</label>
                    <input type="number" id="nServos" value="5" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                  </div>
                  <button onclick="app.settings.apply()" class="w-full px-4 py-2 bg-blue-600 rounded-lg btn-glow">Apply & Rerender</button>
                  <p class="text-xs text-gray-400">Changes require re-rendering UI components.</p>
                </div>
              </div>
            </section>

            <section id="logs" class="tab-content">
              <div class="glass rounded-xl p-4">
                <h2 class="text-xl font-bold text-cyan-300 mb-2">System Logs</h2>
                <div id="logBox" class="font-mono bg-black/50 text-sm p-3 h-96 overflow-y-auto rounded"></div>
              </div>
            </section>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 glass flex justify-around p-2 border-t border-[var(--glass-border)]">
        <button class="nav-btn flex flex-col items-center w-full text-xs active" data-tab="dashboard"><i class="fas fa-tachometer-alt text-lg mb-1"></i>Dashboard</button>
        <button class="nav-btn flex flex-col items-center w-full text-xs" data-tab="manual"><i class="fas fa-sliders-h text-lg mb-1"></i>Manual</button>
        <button class="nav-btn flex flex-col items-center w-full text-xs" data-tab="sequencer"><i class="fas fa-tasks text-lg mb-1"></i>Sequencer</button>
        <button class="nav-btn flex flex-col items-center w-full text-xs" data-tab="settings"><i class="fas fa-cog text-lg mb-1"></i>Settings</button>
        <button class="nav-btn flex flex-col items-center w-full text-xs" data-tab="logs"><i class="fas fa-file-alt text-lg mb-1"></i>Logs</button>
    </nav>

    <!-- Connection Modal -->
    <div id="connection-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
      <div class="glass rounded-xl p-6 max-w-sm w-full text-center">
        <h2 class="text-2xl font-bold text-cyan-300 mb-4">Connect to Robot Arm</h2>
        <div class="space-y-4">
          <button id="connectWsBtn" class="w-full px-4 py-3 bg-green-600 rounded-lg font-semibold btn-glow">Connect via WebSocket</button>
          <button id="connectBtBtn" class="w-full px-4 py-3 bg-sky-600 rounded-lg font-semibold btn-glow">Connect via Bluetooth</button>
          <button id="connectDemoBtn" class="w-full px-4 py-3 bg-yellow-600/80 rounded-lg font-semibold btn-glow">Enter Demo Mode</button>
        </div>
        <button id="closeModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- Main App Logic ---
    (() => {
        const app = {
            // ... (The entire 'app' object from your original script)
            state: { connected: false, connectionType: null, servos: [], N_SERVOS: 5, socket: null, btDevice: null, btCharacteristic: null },
            init() { this.log('System initialized.', 'info'); this.ui.init(); this.settings.init(); this.manualControl.init(); this.sequencer.init(); },
            log(message, type = 'log') { const box = document.getElementById('logBox'); const colors = { log: 'text-green-400', error: 'text-red-400', info: 'text-cyan-400', cmd: 'text-yellow-400' }; box.innerHTML += `<div class="flex"><span class="mr-2 text-gray-500">[${new Date().toLocaleTimeString()}]</span><span class="${colors[type]}">${message}</span></div>`; box.scrollTop = box.scrollHeight; },
            connectivity: {
                connectWS() { const ip = prompt("Enter ESP32 WebSocket IP address:", "192.168.4.1"); if (!ip) return; app.log(`Connecting to WebSocket server at ws://${ip}:81/...`, 'info'); const socket = new WebSocket(`ws://${ip}:81/`); socket.onopen = () => { app.state.socket = socket; app.state.connected = true; app.state.connectionType = 'ws'; app.ui.updateStatus(true, 'WebSocket'); app.log('WebSocket connection established.', 'log'); app.ui.closeConnectionModal(); }; socket.onmessage = (event) => app.helpers.parseMessage(event.data); socket.onclose = () => { app.state.connected = false; app.state.connectionType = null; app.ui.updateStatus(false); app.log('WebSocket disconnected.', 'error'); }; socket.onerror = (error) => app.log(`WebSocket error: ${error.message}`, 'error'); },
                async connectBT() { app.log('Web Bluetooth requires a secure context (HTTPS).', 'info'); if (!navigator.bluetooth) { return app.log('Web Bluetooth API not available on this browser.', 'error'); } try { app.log('Requesting Bluetooth device...', 'info'); app.state.btDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b'] }] }); app.log(`Connecting to GATT Server on ${app.state.btDevice.name}...`, 'info'); const server = await app.state.btDevice.gatt.connect(); const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b'); app.state.btCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8'); app.state.connected = true; app.state.connectionType = 'bt'; app.ui.updateStatus(true, 'Bluetooth'); app.log(`Bluetooth connected to ${app.state.btDevice.name}.`, 'log'); app.ui.closeConnectionModal(); } catch (error) { app.log(`Bluetooth connection failed: ${error}`, 'error'); } },
                connectDemo() { app.state.connected = true; app.state.connectionType = 'demo'; app.ui.updateStatus(true, 'Demo'); app.log('Demo mode activated. No hardware required.', 'info'); app.ui.closeConnectionModal(); },
            },
            sendCommand(cmd) { if (!this.state.connected) { this.log('Not connected. Command not sent.', 'error'); return; } this.log(`CMD: ${cmd}`, 'cmd'); if (this.state.connectionType === 'ws') { this.state.socket.send(cmd); } else if (this.state.connectionType === 'bt') { this.state.btCharacteristic.writeValue(new TextEncoder().encode(cmd + '\n')); } else if (this.state.connectionType === 'demo') { this.log(`Simulating: ${cmd}`, 'info'); this.helpers.parseMessage(cmd); } },
            helpers: {
                parseMessage(data) { if (data.startsWith('POS:') || data.startsWith('SET:')) { const parts = data.substring(4).split(','); const newAngles = [...app.state.servos]; parts.forEach(p => { const [index, angle] = p.split(':').map(Number); if (!isNaN(index) && !isNaN(angle) && index < app.state.N_SERVOS) { newAngles[index] = angle; } }); app.state.servos = newAngles; app.manualControl.updateSliders(); app.ui.updateJointAngles(); } else if (data.startsWith('SENSOR:PROXIMITY:')) { const proximity = parseFloat(data.substring(17)); app.ui.updateSensorData(proximity); } else { app.log(`RX: ${data}`); } },
                debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
            },
            ui: {
                init() { this.setupTabs(); this.setupTheme(); this.setupConnectionModal(); app.state.servos = Array(app.state.N_SERVOS).fill(90); this.updateJointAngles(); },
                setupTabs() { document.querySelectorAll('.nav-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll(`.nav-btn[data-tab="${btn.dataset.tab}"]`).forEach(t => t.classList.add('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(btn.dataset.tab).classList.add('active'); }); }); },
                setupTheme() { const themeToggle = document.getElementById('themeToggle'); const themeIcon = document.getElementById('themeIcon'); const applyTheme = (isDark) => { document.documentElement.classList.toggle('dark', isDark); themeIcon.classList.toggle('fa-sun', isDark); themeIcon.classList.toggle('fa-moon', !isDark); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }; themeToggle.addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark'))); applyTheme(localStorage.getItem('theme') !== 'light'); },
                setupConnectionModal() { document.getElementById('connectBtn').addEventListener('click', () => this.openConnectionModal()); document.getElementById('closeModalBtn').addEventListener('click', () => this.closeConnectionModal()); document.getElementById('connectWsBtn').addEventListener('click', () => app.connectivity.connectWS()); document.getElementById('connectBtBtn').addEventListener('click', () => app.connectivity.connectBT()); document.getElementById('connectDemoBtn').addEventListener('click', () => app.connectivity.connectDemo()); },
                openConnectionModal() { document.getElementById('connection-modal').classList.remove('hidden'); },
                closeConnectionModal() { document.getElementById('connection-modal').classList.add('hidden'); },
                updateStatus(isConnected, type = '') { const s = document.getElementById('status'); if (isConnected) { s.textContent = `CONNECTED (${type})`; s.className = 'py-2 px-4 inline-block rounded-full border border-green-500 text-green-400 transition-all'; } else { s.textContent = 'DISCONNECTED'; s.className = 'py-2 px-4 inline-block rounded-full border border-red-500 text-red-400 transition-all'; } },
                updateJointAngles() { const jointAnglesDiv = document.getElementById('joint-angles'); const servoNames = ['Base', 'Shoulder', 'Elbow', 'Wrist', 'Gripper']; jointAnglesDiv.innerHTML = app.state.servos.map((angle, i) => ` <div class="glass p-3 rounded-lg"> <div class="text-sm text-gray-400">${servoNames[i] || `Joint ${i}`}</div> <div class="font-mono text-2xl font-bold">${angle}Â°</div> </div>`).join(''); },
                updateSensorData(proximity) { document.getElementById('sensor-data').textContent = `Proximity: ${!isNaN(proximity) ? proximity + ' cm' : 'None'}`; }
            },
            settings: {
                init() { document.getElementById('nServos').value = app.state.N_SERVOS; },
                apply() { const newServoCount = parseInt(document.getElementById('nServos').value, 10); if (newServoCount > 0 && newServoCount !== app.state.N_SERVOS) { app.state.N_SERVOS = newServoCount; app.state.servos = Array(app.state.N_SERVOS).fill(90); app.manualControl.init(); app.ui.updateJointAngles(); app.log(`Settings updated. Servo count is now ${app.state.N_SERVOS}`, 'info'); } }
            },
            manualControl: {
                init() { this.createSliders(); this.initJoystick(); },
                createSliders() { const slidersDiv = document.getElementById('sliders'); slidersDiv.innerHTML = ''; const servoNames = ['Base', 'Shoulder', 'Elbow', 'Wrist', 'Gripper']; for (let i = 0; i < app.state.N_SERVOS; i++) { const name = servoNames[i] || `Joint ${i}`; const wrap = document.createElement('div'); wrap.innerHTML = ` <label class="block mb-2">${name}: <span id="v${i}" class="font-mono float-right">${app.state.servos[i]}Â°</span></label> <input type="range" min="0" max="180" value="${app.state.servos[i]}" id="s${i}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">`; slidersDiv.appendChild(wrap); const debouncedSend = app.helpers.debounce((cmd) => app.sendCommand(cmd), 50); wrap.querySelector('input').addEventListener('input', e => { const angle = parseInt(e.target.value, 10); document.getElementById(`v${i}`).textContent = `${angle}Â°`; app.state.servos[i] = angle; debouncedSend(`SET:${i}:${angle}`); app.ui.updateJointAngles(); }); } },
                updateSliders() { for (let i = 0; i < app.state.N_SERVOS; i++) { const slider = document.getElementById(`s${i}`); if (slider) { slider.value = app.state.servos[i]; document.getElementById(`v${i}`).textContent = `${app.state.servos[i]}Â°`; } } },
                initJoystick() { const container = document.getElementById('joystick-container'); const handle = document.getElementById('joystick-handle'); let isDragging = false; const onStart = (e) => { isDragging = true; handle.classList.add('grabbing'); handle.style.transition = 'none'; }; const onEnd = () => { if (!isDragging) return; isDragging = false; handle.classList.remove('grabbing'); handle.style.transition = 'transform 0.2s ease-out'; handle.style.transform = 'translate(-50%, -50%)'; [0, 1].forEach(i => { app.state.servos[i] = 90; app.sendCommand(`SET:${i}:90`); }); this.updateSliders(); app.ui.updateJointAngles(); }; const onMove = (e) => { if (!isDragging) return; e.preventDefault(); const rect = container.getBoundingClientRect(); const touch = e.touches ? e.touches[0] : e; const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2; let x = touch.clientX - centerX; let y = touch.clientY - centerY; const maxDist = rect.width / 2 - handle.offsetWidth / 2; const dist = Math.min(maxDist, Math.sqrt(x * x + y * y)); const angle = Math.atan2(y, x); const newX = dist * Math.cos(angle); const newY = dist * Math.sin(angle); handle.style.transform = `translate(calc(-50% + ${newX}px), calc(-50% + ${newY}px))`; const baseAngle = Math.round(90 + (newX / maxDist) * 90); const shoulderAngle = Math.round(90 - (newY / maxDist) * 90); if (app.state.servos[0] !== baseAngle) { app.state.servos[0] = baseAngle; app.sendCommand(`SET:0:${baseAngle}`); } if (app.state.servos[1] !== shoulderAngle) { app.state.servos[1] = shoulderAngle; app.sendCommand(`SET:1:${shoulderAngle}`); } this.updateSliders(); app.ui.updateJointAngles(); }; handle.addEventListener('mousedown', onStart); handle.addEventListener('touchstart', onStart, { passive: true }); window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd); window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove, { passive: false }); }
            },
            sequencer: {
                sequence: [], isPlaying: false,
                init() { document.getElementById('import-file').addEventListener('change', this.importJSON); },
                addStep() { const step = { positions: [...app.state.servos], delay: 1000 }; this.sequence.push(step); this.render(); app.log('Sequence step added.', 'info'); },
                render() { const list = document.getElementById('sequenceList'); list.innerHTML = this.sequence.map((step, i) => ` <div class="glass p-2 rounded-lg flex items-center justify-between"> <span class="text-sm">Step ${i + 1}: [${step.positions.join(', ')}]</span> <div class="flex items-center gap-2"> <input type="number" value="${step.delay}" class="bg-gray-700 w-20 text-center rounded" onchange="app.sequencer.updateDelay(${i}, this.value)"> ms <button onclick="app.sequencer.removeStep(${i})" class="text-red-400 font-bold px-2">X</button> </div> </div>`).join(''); },
                updateDelay(index, delay) { this.sequence[index].delay = parseInt(delay, 10); },
                removeStep(index) { this.sequence.splice(index, 1); this.render(); },
                play() { if (this.isPlaying || this.sequence.length === 0) return; this.isPlaying = true; document.getElementById('playSeqBtn').textContent = 'Playing...'; document.getElementById('sequence-progress').style.display = 'block'; let totalTime = this.sequence.reduce((acc, step) => acc + step.delay, 0); let elapsed = 0; const executeStep = (index) => { if (index >= this.sequence.length) { this.isPlaying = false; document.getElementById('playSeqBtn').textContent = 'Play'; document.getElementById('sequence-progress-bar').style.width = '100%'; setTimeout(() => { document.getElementById('sequence-progress').style.display = 'none'; document.getElementById('sequence-progress-bar').style.width = '0%'; }, 500); return; } const step = this.sequence[index]; let commandString = step.positions.map((angle, i) => `${i}:${angle}`).join(','); app.sendCommand(`SET:${commandString}`); app.state.servos = [...step.positions]; app.manualControl.updateSliders(); app.ui.updateJointAngles(); let progressInterval = setInterval(() => { elapsed += 50; document.getElementById('sequence-progress-bar').style.width = `${(elapsed / totalTime) * 100}%`; }, 50); setTimeout(() => { clearInterval(progressInterval); executeStep(index + 1); }, step.delay); }; executeStep(0); },
                clear() { this.sequence = []; this.render(); app.log('Sequence cleared.', 'info'); },
                exportJSON() { const dataStr = JSON.stringify(this.sequence, null, 2); const link = document.createElement('a'); link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr); link.download = 'robot-sequence.json'; link.click(); },
                importJSON(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedSeq = JSON.parse(e.target.result); if (Array.isArray(importedSeq)) { app.sequencer.sequence = importedSeq; app.sequencer.render(); app.log('Sequence imported successfully.', 'info'); } } catch (err) { app.log(`Error parsing JSON file: ${err.message}`, 'error'); } }; reader.readAsText(file); }
            }
        };
        window.app = app;
        // The app is initialized after the loader finishes.
    })();

    // --- Loader and App Transition Logic ---
    (() => {
        const loadingSteps = ["Activating servos...", "Calibrating movement...", "Connecting control unit...", "Syncing sensors...", "System ready!"];
        let currentStep = 0;
        const progressText = document.getElementById("progressText");

        function updateLoaderText() {
            progressText.textContent = loadingSteps[currentStep];
            if (currentStep < loadingSteps.length - 1) {
                currentStep++;
                setTimeout(updateLoaderText, 800);
            } else {
                // Last step, prepare to transition to the main app
                setTimeout(transitionToApp, 1000);
            }
        }

        function transitionToApp() {
            const loader = document.getElementById('loader');
            const loaderBg = document.getElementById('loader-bg');
            const appContainer = document.getElementById('app-container');

            // Fade out loader elements
            loader.style.opacity = '0';
            loaderBg.style.opacity = '0';

            // After fade out animation completes...
            setTimeout(() => {
                // Hide loader elements from the DOM
                loader.style.display = 'none';
                loaderBg.style.display = 'none';

                // Switch body class to the one required by the app
                document.body.className = 'app-body';

                // Show the main app container
                appContainer.classList.remove('hidden');
                
                // Initialize the main application logic
                document.addEventListener('DOMContentLoaded', () => window.app.init());
                // If DOM is already loaded (which it will be), fire init manually.
                if (document.readyState === "complete" || document.readyState === "interactive") {
                    window.app.init();
                }

                // Fade in the app for a smooth transition
                appContainer.style.opacity = '0';
                appContainer.style.transition = 'opacity 0.5s ease-in';
                setTimeout(() => appContainer.style.opacity = '1', 50);

            }, 500); // This timeout should match the CSS transition duration
        }

        // Start the loader text animation
        updateLoaderText();
    })();
  </script>
</body>
</html>